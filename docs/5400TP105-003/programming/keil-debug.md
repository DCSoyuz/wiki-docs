---
id: mk-keil-debug
title: Отладка в Keil IDE
sidebar_label: Отладка в Keil IDE
sidebar_position: 5
---

Настройка отладчика в Keil IDE и руководство по использованию.

## Настройка отладчика

1. Поместить файл _105-003.dll_ из архива DCSProg6 в каталог <code> C:/Keil_v5/C51/BIN/ </code>.
2. В каталоге <code>C:/Keil_v5/</code> в файле \_TOOLS.ini в разделе C51 найти максимальный номер для TDRV и добавить строку: <br/> <code>TDRV*=BIN\105-003.dll ("5400ТР105-003")</code>, где * – следующий номер после максимального. Далее необходимо сохранить изменения и закрыть файл.

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/toolsini.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Настройка Keil IDE</figcaption>
</figure>
</div>

3. Запустить Keil IDE. В настройках проекта (комбинация Alt+F7 или кнопка «Options for Target» на панели инструментов) во вкладке «Debug» поставить переключатель «Use» и выбрать «Octopus Driver». Ниже установить `«Load Application at Startup»`.

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/1.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Настройка Keil IDE</figcaption>
</figure>
</div>

4. Непосредственно перед запуском отладчика необходимо создать выходной hex-файл отлаживаемой программы <br/> (`«Project» –> «Rebuild all target files»`), подключить программатор DCSProg в USB-порт компьютера, подать на плату питание и частоту.

## Начало работы с отладкой

Запуск отладчика производится комбинацией клавиш Ctrl+F5. При успешном подключении программатора к отладчику в окне логов будет выведено следующее сообщение:

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/2.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Лог при успешном подключении программатора</figcaption>
</figure>
</div>

При неуспешном подключении программатора либо отладчик будет принудительно отключен, либо в окне логов будет выведено следующее сообщение:

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/3.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Лог при неуспешном сбросе программатора</figcaption>
</figure>
</div>

В этом случае необходимо проверить питание и тактирование микросхемы, попробовать заново включить отладчик.

## Возможности отладчика

После загрузки программы в микросхему открывается окно с ассемблерным кодом. Если оно
не открылось, его можно открыть вручную нажатием `«View» –> «Disassembly Window»`. В этом окне можно просматривать ассемблерный код, сопоставленный строкам исходного кода на языке Си. Если окно ассемблерных инструкций изначально отображается по-другому, это можно изменить одиночным нажатием ПКМ по окну ассемблерных инструкций и выбором режима отображения «Mixed Mode».

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/4.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Пример ассемблерного кода в удобочитаемом виде</figcaption>
</figure>
</div>

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/5.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Выбор режима отображения ассемблерных инструкций вместе с Си кодом</figcaption>
</figure>
</div>

:::alert Примечание
При заполнении окна ассемблерных инструкций отладчик не считывает инструкции из микросхемы, а анализирует входной hex-файл. Верификация записанного кода происходит только при команде <a href="/docs/5400TP105-003/programming/mk-keil-debug#команда-flash-download">«Flash Download»</a>
:::

В отладочном окне в левом верхнем углу находится основная панель инструментов для управления выполнением программы:

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/6.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Панель для управления исполнением программы</figcaption>
</figure>
</div>

|     |                                                                                                                                             |
| --- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Кнопка «RST» сбрасывает выполнение всех инструкций и возвращает PC («Program Counter») в начало программы.                                  |
| 2   | Кнопка «Run» запускает выполнение программы с текущего PC. Выполнение программы остановится по окончанию или при встрече брейкпоинта.       |
| 3   | Кнопка «Stop» прерывает выполнение программы. PC остаётся на последней выполненной инструкции.                                              |
| 4   | Кнопка «Step» выполняет одну инструкцию программы, на которую указывает PC.                                                                 |
| 5   | Кнопка «Step Over» пропускает одну инструкцию программы, на которую указывает PC.                                                           |
| 6   | Кнопка «Run to Cursor Line» выполняет программу до той строки, на которую указывает курсор в окне ассемблерного кода или в окне кода на Си. |

При нажатии ПКМ на строку в ассемблерном окне или в окне Си кода можно задать PC на эту инструкцию, используя команду «Set Program Counter». При нажатии кнопки «Run» исполнение программы начнется с инструкции, на которую указывает установленный «PC».

<div className="doc-image-container">
<table className="table">
<tbody>

  <tr>
    <td >Установка PC в окне ассемблерного кода</td>
    <td >Установка PC в окне Си кода</td>
  </tr>
  <tr>
    <td>
    <img src="/img/5400TP105-003/keil-debug/7.png" alt="" />
    </td>
    <td>
    <img src="/img/5400TP105-003/keil-debug/8.png" alt="" />
    </td>
  </tr>
</tbody>
</table>
</div>

В левой части отладочного окна можно отслеживать состояние SFR регистров ядра 8051. При остановке исполнения программы (принудительно или по брейкпоинту) происходит чтение значений и обновление окна SFR регистров. В остановленном состоянии можно изменять значения SFR регистров, используя данное окно.

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/9.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Окно SFR регистров ядра 8051</figcaption>
</figure>
</div>

## Использование точек останова

Отладчик поддерживает до четырёх брейкпоинтов одновременно. Чтобы установить/удалить брейкпоинт необходимо в области кода слева от нужной строки нажать ЛКМ.

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/10.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Точка останова</figcaption>
</figure>
</div>

:::info Примечание
Команда «Run to Cursor Line» использует брейкпоинт, поэтому при использовании этой команды необходимо убедиться, что в данный момент установлено максимум три брейкпоинта.
:::

:::info Примечание
Команда «Step Over» при прохождении функции использует брейкпоинт, поэтому
при использовании этой команды необходимо убедиться, что в данный момент установлено максимум три брейкпоинта.
:::

## Просмотр состояния переменных

1. Открыть окно с отслеживанием переменных можно по нажатию `«View» –> «Watch Windows» –> «Watch 1»`. Снизу отладочного окна появится вкладка «Watch 1».
2. В данной вкладке можно ввести название переменной в столбец «Name», состояние которой необходимо отслеживать.
3. При успешном добавлении переменной будет отображено её значение и тип, при неуспешном добавлении в столбце «Value» будет отображаться «cannot evaluate».
4. Считывание переменной происходит при остановке программы.

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/11.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Окно для отслеживания переменных</figcaption>
</figure>
</div>

:::info Примечание
При помощи этого окна можно изменять состояние переменных при остановленной программе. Если переменная хранится во внутренней ОЗУ, то состояние меняется, если переменная хранится во внешней ОЗУ (ключевое слово «xdata»), то её состояние не изменяется.
:::

## Команда «Flash Download»

Для загрузки программы из Keil IDE в микросхему необходимо в настройках проекта (Alt+F7) во вкладке «Utilities» в меню настроек «Flash Download» указать следующие настройки:

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/12.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Настройки проекта для включения возможности загружать программу сразу из Keil IDE</figcaption>
</figure>
</div>

На панели инструментов окна Keil IDE есть кнопка, которая очищает память программ, заполняя ее нулями, затем программа загружается в микросхему, в конце программа считывается из микросхемы и по байтам сравнивается с тем, что должно быть загружено.

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/13.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Кнопка «Flash Download» на панели инструментов Keil IDE</figcaption>
</figure>
</div>

При успешном подключении к программатору, успешной записи и верификации загруженной в микросхему программы в окне логов будет выведено сообщение о том, что все байты загружаемой программы совпали.

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/keil-debug/14.png" alt="" />
  <figcaption  className="doc-image-container__image-title">Cообщение в окне логов о том, что все 249 байт программы были загружены</figcaption>
</figure>
</div>

При обнаружении несовпадений байтов программы об этом также будет сообщено в окне логов.
В таком случае рекомендуется заново подать питание и тактирование микросхемы и попробовать снова загрузить программу.

:::info Примечание
Кнопка «Flash Download» лишь так называется в контексте Keil IDE. В контексте микросхемы программа будет загружаться в RAM_ROM область в SOFT режиме, так как флеш-память у микросхемы 105-003 отсутствует как таковая.

После успешной загрузки и верификации программы для её запуска необходимо нажать на отладочной плате кнопку «RESET».

Такая загрузка происходит относительно долго, т.к. перед записью и верификацией программы происходит полное затирание RAM_ROM области (все 4096 байт заполняются нулями).
:::
