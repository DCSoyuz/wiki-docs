---
id: mk-prog
title: Программирование
sidebar_label: Программирование
sidebar_position: 2
---

Программирование микроконтроллера в SOFT и HARD режимы.

## Подготовка к работе с отладочным комплектом

1. Подключить блок питания к плате
2. Соединить плату с ПК с помощью USB-кабеля

Зайти в диспетчер устройств

`Для Windows 10` – нажмите по иконке поиска в панели задач и наберите «диспетчер устройств» в поле ввода, а после того, как нужный элемент будет найден, нажмите по нему ЛКМ для открытия.

`Для Windows 7 и 8` – откройте пуск и введите в поле поиска фразу «диспетчер устройств», а после того, как нужный элемент будет найден, нажмите по нему ЛКМ для открытия.

Во вкладке «Порты (COM и LPT)» можно посмотреть какой СОМ-порт соответствует отладочной плате. В примере плата подключена к порту COM3.

<DocumentFigure src="/img/5400TP105-003/programming/7.png" caption="Диспетчер устройств" />

Если компьютер не распознает отладочную плату, то следует установить драйвер СP210x: загрузить архив CP210x_Windows_Drivers с сайта компании [https://dcsoyuz.ru](https://dcsoyuz.ru) в разделе «Программное обеспечение», либо с сайта разработчика [ttps://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers](ttps://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers).

## Режимы работы микросхемы

Микросхема 5400ТР105-003 имеет два режима работы:

- режим отладки с возможностью многократного перепрограммирования (`режим «SOFT»`);
- режим финальной конфигурации с записью в энергонезависимую память (`режим «HARD»`).

## Программирование микросхемы в режим «SOFT»

1. Вставьте микросхему в контактирующее устройство на отладочной плате. Направление первого вывода микросхемы указано шелкографией с цифрой «1» над контактирующим устройством. Прижмите микросхему крышкой контактирующего устройства.
2. Нажать кнопку включения питания на плате ([Рисунок, элемент №18](/docs/5400TP105-003/programming/mk-develop-kit#описание-элементов-отладочной-платы));
3. В случае использования внешнего генератора. Перевести переключатель ([Рисунок, элемент №9](/docs/5400TP105-003/programming/mk-develop-kit#описание-элементов-отладочной-платы))
   в положение «GEN». Подать прямоугольный сигнал (меандр) от 0 В до 5,0 В с частотой 4 МГц (допустимый диапазон частоты от 500 кГц до 8 МГц) на вывод ([Рисунок, элемент №8](/docs/5400TP105-003/programming/mk-develop-kit#описание-элементов-отладочной-платы)).
   В случае использования кварцевого резонатора необходимо перевести переключатель ([Рисунок, элемент №9](/docs/5400TP105-003/programming/mk-develop-kit#описание-элементов-отладочной-платы)) в положение «RES».

4. Запустить приложение DCSProg.exe из папки DCSProg;

При подключении платы и включении питания происходит автоматическая идентификация платы в правом нижнем углу программы. Если идентификация не прошла, то приложение опрашивает COM-порт каждые 3 секунды. Без идентификации программирование микросхемы невозможно.

:::info Примечание
Если требуется программирование микросхемы в составе вашего устройства (без отладочной платы КФЦС.441461.196) с помощью программатора, то для завершения идентификации необходимо нажать сочетание клавиш `Ctrl+F12` и в окне выбрать микросхему `«5400ТР105-003»`. После этого идентификация будет пройдена и программирование станет доступно.
:::

:::caution Важно!
Если идентификация не проходит, сообщите о проблеме в службу технической поддержки по электронной почте support@dcsoyuz.ru. Проведение идентификации с помощью диалогового окна (сочетание клавиш Ctrl+F12) в составе отладочного комплекта не является штатным режимом работы.
:::

<DocumentFigure src="/img/5400TP105-003/programming/8.png" caption="Завершение идентификации через диалоговое меню" />


Если подключено больше одного COM-порта к компьютеру, то программа выведет диалоговое окно с выбором СОМ-порта. В диалоговом окне выберите СОМ-порт,
который соответствует плате, и нажмите «ОК».

Методика определения СОМ-порта приведена в пункте в пункте «Подготовка к работе с отладочным комплектом». После автоматической идентификации в правом нижнем углу программы появится надпись «5400ТР105-003».

5. После идентификации загрузите файл с конфигурацией:
   `«Микросхема» –> «Загрузить hex файл»`, выбрать ранее скомпилированный hex-файл и нажать кнопку «Открыть» (расположение файла: `«…\Projects\Example\Objects»`);


<DocumentFigure src="/img/5400TP105-003/programming/9.png" caption="Расположение hex-файла" />


Выбранный hex-файл отобразится в программе DCSProg:

<DocumentFigure src="/img/5400TP105-003/programming/10.png" caption="Окно программы после загрузки hex-файла" />


7. Для программирования микросхемы в режиме отладки (режим «SOFT») выполнить: `«Микросхема» –> «Прошить ОЗУ»`.

<DocumentFigure src="/img/5400TP105-003/programming/11.png" caption="Программирование микросхемы в режиме «SOFT»" />


В случае успешного программирования в окне программы будет выведено `«Микросхема запрограммирована в режиме SOFT»`.

<DocumentFigure src="/img/5400TP105-003/programming/12.png" caption="Сообщение о успешном программировании в режиме «SOFT»" />

В случае ошибок при программировании в окне программы будет указан первый адрес, в котором возникла ошибка записи.

<DocumentFigure src="/img/5400TP105-003/programming/13.png" caption="Ошибка при программировании в режиме «SOFT»" />

8. Микросхема запрограммирована и работает в режиме отладки (режим «SOFT»).
9. Для перепрограммирования микросхемы в режиме «SOFT» (отладка микросхемы) повторить методику с пункта 6.

В случае успешного программирования микросхемы на отладочной плате будут мигать светодиоды VD1-VD4.

Временная диаграмма представлена на рисунке ниже.

<DocumentFigure src="/img/5400TP105-003/programming/dia.png" caption="Временная диаграмма работы проекта Example.uvproj (t1 – ~60 мс)" />


## Программирование микросхемы в режим режим «HARD»

1. Запрограммировать микросхему в режим «SOFT».
2. Выполнить `«Микросхема» –> «Прожечь ПЗУ»`. В открывшемся окне подтвердить программирование микросхемы – кнопка «Yes»;

<DocumentFigure src="/img/5400TP105-003/programming/14.png" caption="Программирование микросхемы в режим «HARD»" />

:::caution Важно!
Прожиг объемной программы занимает длительное время. В момент прожига взаимодействие с программой DCSProg.exe запрещено.
:::

После завершения программирования микросхемы программа выдаст сообщение `«Микросхема запрограммирована в ПЗУ»`. По завершению программирования произойдет автоматический программный сброс микроконтроллера по JTAG.

<DocumentFigure src="/img/5400TP105-003/programming/15.png" caption="Окно окончания программирования" />

В случае ошибок при программировании в окне программы будет указан первый адрес, в котором возникла ошибка записи.

<DocumentFigure src="/img/5400TP105-003/programming/16.png" caption="Ошибка записи в ПЗУ" />

После программирования в режиме «HARD» в качестве проверки верной записи данных можно считать их из однократно программируемого ПЗУ. Для этого необходимо выполнить `«Микросхема» –> «Считать ПЗУ микросхемы»`. Считанные данные запишутся в файл Read_ROM_time.txt.

<DocumentFigure src="/img/5400TP105-003/programming/17.png" caption="Считывание ПЗУ" />

## Программирование конфигурационной памяти в режим режим «SOFT»

В микросхеме реализована конфигурационная память, которая может работать как в «SOFT», так и в «HARD» режиме. Более подробно о регистрах конфигурационной памяти в разделе[«Конфигурационная память»](/docs/5400TP105-003/mk-analog-cfg). Регистры модуля [ANALOG_CFG](/docs/5400TP105-003/mk-analog-cfg#регистры-модуля-analog_cfg) подключены к конфигурационному однократно программируемому ПЗУ.

1. Открыть проект «analog_cfg_ex.uvproj». Путь к файлу проекта в архиве Projects.zip `…/Projects/ANALOG_CFG/ analog_cfg_ex.uvproj`;

Данный проект настраивает частоту RC-генератора на выводе GPIOB_1.

2. Для настройки конфигурационной памяти необходимо выставить нужные биты в проекте analog_cfg_ex.uvproj в регистрах ANALOG_CFG согласно [таблице](/docs/5400TP105-003/mk-analog-cfg#регистры-модуля-analog_cfg).

<DocumentFigure src="/img/5400TP105-003/programming/18.png" caption="Пример настройки конфигурационной памяти" />

3. Выполнить `«Микросхема» –> «Загрузить файл»`, выбрать скомпилированный hex-файл и нажать кнопку «Открыть»;

<DocumentFigure src="/img/5400TP105-003/programming/19.png" caption="Окно программы после выбора hex-файла" />


4. Выполнить `«Конфигурационная память» –> «Прошить конфигурационную память»` для программирования в режиме отладки (режим «SOFT»);

<DocumentFigure src="/img/5400TP105-003/programming/20.png" caption="Прошивка конфигурационной памяти («SOFT»)" />


5. После завершения программирования программа выдаст сообщение `«Конфигурационная память настроена в режиме «SOFT»`.

<DocumentFigure src="/img/5400TP105-003/programming/21.png" caption="Завершение настройки конфигурационной памяти" />


Результат программирования конфигурационной памяти можно проверить на выводе GPIOB&lt;1&gt; – частота RC-генератора.

## Программирование конфигурационной памяти в режим «HARD»

1. Настроить конфигурационную память в режиме «SOFT»;
2. Выполнить `«Конфигурационная память – Прожечь конфигурационную память»`.

<DocumentFigure src="/img/5400TP105-003/programming/22.png" caption="Прожиг конфигурационной памяти («HARD»)" />

Конфигурационная память запрограммирована и работает в режиме финальной конфигурации (режим «HARD»). Результат программирования можно проверить на выводе GPIOB_1 – частота внутреннего RC-генератора.

## Программный сброс

Помимо аппаратного сброса ([Рисунок, элемент №14](/docs/5400TP105-003/programming/mk-develop-kit#описание-элементов-отладочной-платы)) на отладочной плате в DCSProg реализован программный сброс. Для сброса необходимо выполнить `«Микросхема» –> «Программный сброс»`, при этом программа начнет выполняться заново.

<DocumentFigure src="/img/5400TP105-003/programming/23.png" caption="Программный сброс" />

## Настройка напряжения питания универсальных портов ввода-вывода

В ПО есть возможность настройки напряжения на выводе VDD_DR (Положительное напряжение питания универсальных портов ввода-вывода микроконтроллера). По умолчанию на выводе VDD_DR установлено напряжение 5,0 В.

В пункте меню «VDD_DR» из выпадающего списка выберите требуемое напряжение.

<DocumentFigure src="/img/5400TP105-003/programming/24.png" caption="Выбор напряжения на выводе VDD_DR" />


После выбора напряжения программа выдаст информационное сообщение.


<DocumentFigure src="/img/5400TP105-003/programming/25.png" caption="Результат успешного переключения напряжения на выводе VDD_DR" />

При отключении питания и повторном включении, напряжение на выводе VDD_DR установится по умолчанию (5,0 В).

## Обновление программного обеспечения

Для обновления ПО программатора необходимо:

1. Скачать новый архив DCSProg.zip с сайта компании [https://dcsoyuz.ru](https://dcsoyuz.ru) (раздел «Программное обеспечение») и извлечь данные на персональный компьютер.
2. Открыть программу DCSProg.exe из скачанного архива и выполнить `«Помощь» –> «Обновить ПО»`.

Программатор обновляет свою прошивку с помощью .hex-файла из корневой директории архива.

<DocumentFigure src="/img/5400TP105-003/programming/26.png" caption="Меню обновления DCSProg" />

3. Перезапустить приложение DCSProg.exe.
