---
id: mk-structure
title: Структура контроллера, карта памяти
sidebar_label: Структура контроллера, карта памяти
sidebar_position: 3
---

## Блок схема

<DocumentFigure src="/img/5400TP105-003/structure/блок_схема.svg" caption="Блок схема 5400ТР105-003" />

## Состав микроконтроллера

### Системные устройства

- [CPU_8051](/docs/5400TP105-003/mk-core8051) – процессорное ядро;
- TAP (Test Access Port) – автомат JTAG;
- TDR (Test Data Register) – регистры данных JTAG;
- MUX - мультиплексор;
- [ANALOG_CFG_MEM](/docs/5400TP105-003/mk-analog-cfg) - конфигурационная память;
- ROM_OTP_4KB (One-Time Programmable) - однократно программируемое постоянное запоминающее устройство емкостью 4 КБ, память программ устройства;
- RAM_ROM_4KB - оперативное запоминающее устройство емкостью 4 КБ, микроконтроллер работает с данным модулем, как с памятью программ или памятью данных в зависимости   
  от значения вывода DBG;
- RAM_256B - оперативное запоминающее устройство емкостью 256B, для хранения промежуточных данных, память данных устройства;
- SWITCH - модуль, разграничивающий доступ к RAM_OTP_4KB, RAM_ROM_4KB, RAM_256B;
- SWITCH JTAG/CPU - модуль, разграничивающий доступ к шине для JTAG и CPU;
- POR (Power-On Reset) - модуль сброса при включении;
- BOR (Brown-Out Reset) - модуль сброса при снижении напряжения питания;
- PMM (Power Management Module) - модуль системы управления сбросом и питанием;
- GEN_PLL - модуль ввода-вывода и фазовой автоподстройки частоты (ФАПЧ) тактирования;
- RC - RC-генератор;
- CMM (Clock Management Module) - модуль управления источниками тактовых сигналов системы;
- DEBUGGER - отладчик;
- OA_TUNE - масштабирующий операционный усилитель (МОУ);
- V_REF - источник опорного напряжения (ИОН);
- LDO_5V->3V7, LDO_5V->1V8 - линейные регуляторы напряжения.

### Периферийные устройства

- INT_CTRL - контроллер прерываний;
- SPI0, SPI1 - модули SPI;
- UART0, UART1 - модули UART;
- I2C - модуль I2C;
- GPIOA, GPIOB, GPIOC - контроллеры портов ввода-вывода;
- TIMER0, TIMER1, TIMER2 - универсальные таймеры;
- WDT - сторожевой таймер;
- WORK_FSM - рабочий автомат для режима «SLEEP»;
- OWI - модуль 1-Wire;
- DAC - цифро-аналоговый преобразователь.
- ADC - аналого-цифрой преобразователь;

## Альтернативные функции выводов GPIO

<table className="table">
<tbody>
 
  <tr>
    <th rowSpan={2}>№</th>
    <th rowSpan={2}>Вывод</th>
    <th colSpan={3}>Альтернативная функция</th>
    <th rowSpan={2}>Пяснение</th>
  </tr>

<tr>
  <th>АФ1</th>
  <th>АФ2</th>
  <th>АФ3</th>
</tr>

  <tr>
    <td colSpan={6}><b>Порт А</b></td>
    
  </tr>
  <tr>
    <td >20</td>
    <td >GPIOA_0</td>
    <td >SPI0_MOSI</td>
    <td >SPI1_MOSI</td>
    <td >I_TIMER0_EXT</td>
    <td >
    <ul >
        <li>SPI0/1 – MOSI (направление определяется режимом работы «ведущий»/«ведомый»)</li>
        <li>TIMER0 – I_TIMER0_EXT (вход)</li>
    </ul>
    </td>
  </tr>
    <tr>
    <td >21</td>
    <td >GPIOA_1</td>
    <td >SPI0_MISO</td>
    <td >SPI1_MISO</td>
    <td >I_TIMER1_EXT</td>
    <td >
    <ul >
        <li>SPI0/1 – MISO (направление определяется режимом работы «ведущий»/«ведомый»);</li>
        <li>TIMER1 – I_TIMER1_EXT (вход).</li>
    </ul>
    </td>
  </tr>
    <tr>
    <td >22</td>
    <td >GPIOA_2</td>
    <td >SPI0_SCK</td>
    <td >SPI1_SCK</td>
    <td >O_SLEEP</td>
    <td >
    <ul >
        <li>SPI0/1 – SCK (направление определяется режимом работы «ведущий»/«ведомый»);</li>
        <li>режим «Глубокий сон» – O_SLEEP (выход).</li>
    </ul>
    </td>
  </tr>
      <tr>
    <td >23</td>
    <td >GPIOA_3</td>
    <td >SPI0_I_CS</td>
    <td >SPI1_I_CS</td>
    <td >SPI0_O_CS</td>
    <td >
    <ul >
        <li>SPI0/1 – I_CS (вход);</li>
        <li>SPI0 – O_CS (выход).</li>
    </ul>
    </td>
  </tr>
      <tr>
    <td >24</td>
    <td >GPIOA_4</td>
    <td >UART0_TX</td>
    <td >UART1_TX</td>
    <td >SPI1_O_CS</td>
    <td >
    <ul >
        <li>UART0/1 – TX (выход);</li>
        <li>SPI1 – O_CS (выход).</li>
    </ul>
    </td>
  </tr>
      <tr>
    <td >25</td>
    <td >GPIOA_5</td>
    <td >UART0_RX</td>
    <td >UART1_RX</td>
    <td >«0»</td>
    <td >
    <ul >
        <li>UART0/1 – RX (вход);</li>
        <li>лог. «0» (выход).</li>
    </ul>
    </td>
  </tr>
      <tr>
    <td >26</td>
    <td >GPIOA_6</td>
    <td >I2C_SCL</td>
    <td >UART0_CTS</td>
    <td >UART1_CTS</td>
    <td >
    <ul >
        <li>I2C – SCL (направление определяется режимом работы «ведущий»/«ведомый»);</li>
        <li>UART0/1 – CTS (вход).</li>
    </ul>
    </td>
  </tr>
      <tr>
    <td >27</td>
    <td >GPIOA_7</td>
    <td >I2C_SDA</td>
    <td >UART0_RTS</td>
    <td >UART1_RTS</td>
    <td >
    <ul >
        <li>I2C – SDA (направление определяется протоколом);</li>
        <li>UART0/1 – RTS (выход).</li>
    </ul>
    </td>
  </tr>
      <tr>
    <td colSpan={6}>Порт В</td>
  </tr>
    <tr>
        <td >44</td>
        <td >GPIOB_0>/H_S</td>
        <td >SPI0_MOSI</td>
        <td >SPI1_MOSI</td>
        <td >I_TIMER0_EXT</td>
        <td >
        <ul >
            <li>при TM = 1 вывод принудительно работает как H/S (вход)</li>
            <li>во время обращения к внешним регистрам этот вывод работает как DATA_0 (направление определяется командой)</li>
        </ul>
        </td>
    </tr>
        <tr>
        <td >45</td>
        <td >GPIOB_1/RC_CLKOUT</td>
        <td >SPI0_MISO</td>
        <td >SPI1_MISO</td>
        <td >I_TIMER2_EXT</td>
        <td >
        <ul >
            <li>при TM = 1 вывод принудительно работает как RC_CLKOUT (выход);</li>
            <li>во время обращения к внешним регистрам этот вывод работает как DATA_1 (направление определяется командой)</li>
        </ul>
        </td>
    </tr>
        <tr>
        <td >46</td>
        <td >GPIOB_2</td>
        <td >SPI0_SCK</td>
        <td >SPI1_SCK</td>
        <td >O_SLEEP</td>
        <td >
        Во время обращения к внешним регистрам этот вывод работает как DATA_2 (направление определяется командой)
        </td>
    </tr>
        <tr>
        <td >47</td>
        <td >GPIOB_3</td>
        <td >SPI0_I_CS</td>
        <td >SPI1_I_CS</td>
        <td >SPI0_O_CS</td>
        <td >
        Во время обращения к внешним регистрам этот вывод работает как DATA_3 (направление определяется командой)
        </td>
    </tr>
        <tr>
        <td >48</td>
        <td >GPIOB_4</td>
        <td >UART0_TX</td>
        <td >UART1_TX</td>
        <td >SPI1_O_CS</td>
        <td >
        Во время обращения к внешним регистрам этот вывод работает как DATA_4 (направление определяется командой)
        </td>
    </tr>
        <tr>
        <td >1</td>
        <td >GPIOB_5</td>
        <td >UART0_RX</td>
        <td >UART1_RX</td>
        <td >«0»</td>
        <td >
        Во время обращения к внешним регистрам этот вывод работает как DATA_5 (направление определяется командой)
        </td>
    </tr>
        <tr>
        <td >2</td>
        <td >GPIOB_6</td>
        <td >I2C_SCL</td>
        <td >UART0_CTS</td>
        <td >UART1_CTS</td>
        <td >
        Во время обращения к внешним регистрам этот вывод работает как DATA_6 (направление определяется командой)
        </td>
    </tr>
        <tr>
            <td >3</td>
            <td >GPIOB_7</td>
            <td >I2C_SDA</td>
            <td >UART0_RTS</td>
            <td >UART1_RTS</td>
            <td >
                Во время обращения к внешним регистрам этот вывод работает как DATA_7 (направление определяется командой)
            </td>
    </tr>
    <tr>
        <td colSpan={6}><b>Порт С</b></td>
    </tr>
    <tr>
        <td >9</td>
        <td >GPIOC_0/TCK</td>
        <td >SPI0_MOSI</td>
        <td >SPI1_MOSI</td>
        <td >I_TIMER1_EXT</td>
        <td >
            <ul >
                <li>При TM = 1 вывод принудительно работает как TCK (вход) интерфейса JTAG</li>
                <li>Во время обращения к внешним регистрам этот вывод работает как WR/RD (выход)</li>
            </ul>
        </td>
    </tr>
        <tr>
        <td >10</td>
        <td >GPIOC_1/TMS</td>
        <td >SPI0_MISO</td>
        <td >SPI1_MISO</td>
        <td >I_TIMER2_EXT</td>
        <td >
            <ul >
                <li>При TM = 1 вывод принудительно работает как TMS (вход) интерфейса JTAG</li>
                <li>Во время обращения к внешним регистрам этот вывод работает как EN (выход)</li>
            </ul>
        </td>
    </tr>
        <tr>
        <td >11</td>
        <td >GPIOC_2/TDI</td>
        <td >SPI0_SCK</td>
        <td >SPI1_SCK</td>
        <td >O_SLEEP</td>
        <td >
            <ul >
                <li>При TM = 1 вывод принудительно работает как TDI (вход) интерфейса JTAG</li>
                <li>Во время обращения к внешним регистрам этот вывод работает как SEL_0 (выход)</li>
            </ul>
        </td>
    </tr>
        <tr>
        <td >12</td>
        <td >GPIOC_3/TDO</td>
        <td >SPI0_I_CS</td>
        <td >SPI1_I_CS</td>
        <td >SPI0_O_CS</td>
        <td >
            <ul >
                <li>При TM = 1 вывод принудительно работает как TDO (выход) интерфейса JTAG</li>
                <li>Во время обращения к внешним регистрам этот вывод работает как SEL_1 (выход)</li>
            </ul>
        </td>
    </tr>
        <tr>
        <td >13</td>
        <td >GPIOC_4</td>
        <td >UART0_TX</td>
        <td >UART1_TX</td>
        <td >SPI1_O_CS</td>
        <td >
        Порт ввода-вывода микроконтроллера, разряд №4 группы C
        </td>
    </tr>
        <tr>
        <td >14</td>
        <td >GPIOC_5</td>
        <td >UART0_RX</td>
        <td >UART1_RX</td>
        <td >«0»</td>
        <td >
        Порт ввода-вывода микроконтроллера, разряд №5 группы C
        </td>
    </tr>
        <tr>
        <td >15</td>
        <td >I2C_SCL</td>
        <td >UART0_CTS</td>
        <td >UART1_CTS</td>
        <td >«0»</td>
        <td >
        Во время обращения к внешним регистрам этот вывод работает как SEL_2 (выход)
        </td>
    </tr>
    <tr>
        <td >16</td>
        <td >GPIOC_7</td>
        <td >I2C_SDA</td>
        <td >UART0_RTS</td>
        <td >UART1_RTS</td>
        <td >
        Во время обращения к внешним регистрам этот вывод работает как SEL_3 (выход)
        </td>
    </tr>
</tbody>
</table>

Порты JTAG (TCK, TDI, TMS, TDO) мультиплексированы с портами GPIOC. Выбор назначения выводов (GPIOC или JTAG) осуществляется выводом TM.

Порты интерфейсов (SPI, UART и т.д.) также мультиплексированы с портами GPIO. Выбор назначения выводов осуществляется с помощью альтернативных функций во время работы микроконтроллера.

## Карта памяти

Адресное пространство памяти программ и данных разделено. В данное адресное пространство отображаются различные модули памяти и периферии.

<table className="table">
<tbody>

<tr>
  <th>№</th>
  <th>Выделенное пространство</th>
  <th>Зона</th>
  <th>Аббревиатура</th>
  <th>Описание</th>
</tr>

  <tr>
    <td >0000h</td>
    <td >4 КБ</td>
    <td >ПЗУ</td>
    <td >ROM</td>
    <td >ПЗУ</td>
  </tr>
  <tr>
    <td >0000h</td>
    <td >4352 Б</td>
    <td rowSpan={22}>ОЗУ</td>
    <td >RAM</td>
    <td >ОЗУ</td>
  </tr>
  <tr>
    <td >2000h</td>
    <td >256 Б</td>
    <td >PMM</td>
    <td >Подсистема управления электропитанием</td>
  </tr>
    <tr>
    <td >2100h</td>
    <td >256 Б</td>
    <td >CMM</td>
    <td >Подсистема управления тактированием </td>
  </tr>
      <tr>
    <td >2200h</td>
    <td >256 Б</td>
    <td >WDT</td>
    <td >Сторожевой таймер </td>
  </tr>
      <tr>
    <td >2300h</td>
    <td >256 Б</td>
    <td >GPIOA </td>
    <td rowSpan={3}>Универсальные порты ввода-вывода</td>
  </tr>
      <tr>
    <td >2400h</td>
    <td >256 Б</td>
    <td >GPIOB </td>
    
  </tr>
      <tr>
    <td >2500h</td>
    <td >256 Б</td>
    <td >GPIOC </td>
    
  </tr>
      <tr>
    <td >2600h</td>
    <td >256 Б</td>
    <td >SPI0</td>
    <td rowSpan={2}>Интерфейсы SPI </td>
  </tr>
      <tr>
    <td >2700h</td>
    <td >256 Б</td>
    <td >SPI1</td>
    
  </tr>
      <tr>
    <td >2800h</td>
    <td >256 Б</td>
    <td >UART0</td>
    <td rowSpan={2}>Интерфейсы UART</td>
  </tr>
      <tr>
    <td >2900h</td>
    <td >256 Б</td>
    <td >UART1</td>
  </tr>
      <tr>
    <td >2A00h</td>
    <td >256 Б</td>
    <td >I2C</td>
    <td >Интерфейс I2C</td>
  </tr>
    <tr>
    <td >2B00h</td>
    <td >256 Б</td>
    <td >OWI</td>
    <td >Интерфейс 1-WIRE</td>
  </tr>
      <tr>
    <td >2C00h</td>
    <td >256 Б</td>
    <td >WORK_FSM</td>
    <td >Рабочий автомат</td>
  </tr>
    <tr>
    <td >2D00h</td>
    <td >32 Б</td>
    <td >TIMER0</td>
    <td rowSpan={3}>Таймеры </td>
  </tr>
      <tr>
    <td >2D20h</td>
    <td >32 Б</td>
    <td >TIMER1</td>
  </tr>
      <tr>
    <td >2D40h</td>
    <td >32 Б</td>
    <td >TIMER2</td>
  </tr>
        <tr>
    <td >2F00h</td>
    <td >256 Б</td>
    <td >ADC</td>
    <td >Аналого-цифровой преобразователь</td>
  </tr>
      <tr>
    <td >3000h</td>
    <td >256 Б</td>
    <td >DAC</td>
    <td >Цифро-аналоговый преобразователь</td>
  </tr>
        <tr>
    <td >3100h</td>
    <td >256 Б</td>
    <td >INT_CTRL</td>
    <td >Контроллер прерываний </td>
  </tr>
        <tr>
    <td >3200h</td>
    <td >64 Б</td>
    <td >DEBUGGER</td>
    <td >Отладчик </td>
  </tr>
        <tr>
    <td >3300h</td>
    <td >8 Б</td>
    <td >ANALOG_CFG</td>
    <td >Конфигурационная память аналоговых блоков</td>
  </tr>
  </tbody>
</table>

Если CPU обратится по адресу вне выделенного пространства, то при чтении будут приняты нулевые данные, запись не будет иметь никакого эффекта.

## Распределение адресного пространства

Микроконтроллеры 8051 оперируют двумя типами памяти: памятью программ и памятью данных. Память программ и память данных физически и логически разделены, имеют различные механизмы адресации, работают под управлением различных сигналов и выполняют разные функции.

<DocumentFigure src="/img/5400TP105-003/structure/память_ОЗУ.svg" caption="Структура памяти микроконтроллера в режиме «HARD»" />

<DocumentFigure src="/img/5400TP105-003/structure/память_ПЗУ.svg" caption="Структура памяти микроконтроллера в режиме «SOFT»" />

Обращение к внешней памяти данных осуществляется по команде «movx», а обращение к памяти программ по команде «movc».

Структура резидентной памяти данных представлена на рисунке. Первые 32 байта сгруппированы в 4 банка по 8 регистров R0 - R7.
Команды микроконтроллера могут обращаться к ним как к регистрам общего назначения R0 - R7 и как к ячейкам ОЗУ с прямой адресацией от 00h до 1Fh. Ячейки резидентного ОЗУ с адреса 20h до адреса 2Fh обеспечивают кроме прямой адресации, адресацию 128 битов (0-127).

<DocumentFigure src="/img/5400TP105-003/structure/структура_внутреннего_ОЗУ.svg" caption="Структура резидентной памяти данных" />

Резидентная память данных имеет 8-битную шину адреса, через которую обеспечивается доступ к памяти из регистра адреса – RAR или из регистра-указателя стека – SP. Регистр-указатель стека используется микроконтроллером при работе со стеком. Через регистр адреса осуществляется прямая и косвенная адресация памяти данных.
