---
id: mk-timer
title: Таймер
sidebar_label: Таймер
sidebar_position: 12
---

В системе присутствует 3 модуля таймера. Каждый таймер поддерживает 3 различных независимых режима работы. Кроме того, TIMER0 и TIMER1 дополнительно поддерживают 4-ый режим работы, в котором они взаимодействуют между собой. Каждый модуль имеет внешний вход, который, в зависимости от режима, управляет таймером.

## Структурная схема

<div className="doc-image-container">
<figure>
  <img src="/img/5400TP105-003/timer/Структурная_схема_TIMER.svg" alt="" />
  <figcaption  className="doc-image-container__image-title">Структурная схема двух соединенных модулей таймера</figcaption>
</figure>
</div>

Таймер состоит из следующих блоков:

- REGISTERS – блок для хранения управляющих данных и статусов;
- TIMER – блок управления счетом;
- SWITCHER_CENTRE – переключатель, определяет будут ли использованы внутренние сигналы или сигналы с соседнего таймера;
- ALLOCATOR – выделитель, выделяет фронт и спад внешнего сигнала;
- SYNCHRONIZER – синхронизатор, синхронизирует внешний сигнал к системной частоте;
- SWITCHER_IN – переключатель, определяет источник внешнего сигнала.

## Работа в режиме «Простой таймер»

### Принцип работы

В режиме «Простой таймер» модуль представляет собой 24-разрядный таймер с инкрементацией каждый такт системной частоты. Таймер считает до значения, записанного в регистры периода счета таймера TMR_PRDH, TMR_PRDM и TMR_PRDL. По достижению заданного значения таймер либо останавливается, либо начинает счет с нуля. Данная функция определяется битом CYCLES регистра TMR_CTRL. Также во время работы допускается перезапись текущего периода счета таймера.   
В результате перезаписи текущее значение таймера будет сброшено в 0 и счет начнется заново. Текущее значение таймера находится в регистрах TMR_VALH, TMR_VALM, TMR_VALL.

Значение, до которого будет считать модуль, определяется как: <br /> N<sub>clk</sub>=PRD + 1, где N<sub>clk</sub> – количество тактов системной частоты.

### Статусы и прерывания

Статусы содержаться в регистре TMR_ST. В данном режиме вырабатывается статус окончания счета периода – бит END_PRD. На основании данного статуса возможно возникновение прерывания. Прерывание разрешается путем записи «1» в соответствующий бит регистра маски прерываний TMR_MSK.

### Алгоритм работы

Процедура настройки режима «Простой таймер»:

- в регистры TMR_PRDH, TMR_PRDM и TMR_PRDL записать требуемое значение периода счета таймера;
- в регистре TMR_MSK при необходимости разрешить прерывание;
- в регистре TMR_CTRL:
  - установить требуемое значение бита CYCLES;
  - установить бит T/C в «0»;
  - в биты MODE необходимо записать значение 00b;
  - установить бит EN_EXT в «0»;
  - установить бит EN в «1».
- текущее значение таймера можно вычитать из регистров TMR_VALH, TMR_VALM и TMR_VALL.

## Работа в режиме «Таймер с внешней остановкой»

### Принцип работы

В режиме «Таймер с внешней остановкой» модуль представляет собой 24-разрядный таймер с инкрементацией каждый такт системной частоты. При запуске таймер считает с нуля до момента возникновения заданного события на соответствующем выводе GPIO (альтернативная функция I_TIMER_EXT). Тип события остановки определяется битом STOP_TYPE регистра TMR_CFG. Текущее значение таймера находится в регистрах TMR_VALH, TMR_VALM и TMR_VALL.

### Статусы и прерывания

Статусы содержатся в регистре TMR_ST. В данном режиме вырабатывается статус переполнения таймера – бит OVW и статус остановки таймера по внешнему событию – бит STOP_EVENT. На основании данных статусов возможно возникновение прерываний. Прерывание разрешается путем записи «1» в соответствующий бит регистра маски прерываний TMR_MSK.

### Алгоритм работы

Процедура настройки режима «Таймер с внешней остановкой»:

- в регистре TMR_CFG задать тип события остановки счета таймера путем записи требуемого значения в бит STOP_TYPE;
- в регистре TMR_MSK разрешить необходимые прерывания;
- в регистре TMR_CTRL:
  - установить бит CYCLES в «0»;
  - установить бит T/C в «0»;
  - в биты MODE необходимо записать значение 01b;
  - установить бит EN_EXT в «0»;
  - установить бит EN в «1».
- текущее значения таймера можно вычитать из регистров TMR_VALH, TMR_VALM и TMR_VALL.

## Работа в режиме «Межсобытийный таймер»

### Принцип работы

В режиме «Межсобытийный таймер» модуль представляет собой 24-разрядный таймер с инкрементацией каждый такт системной частоты. После разрешения работы таймер ожидает событие старта на соответствующем выводе GPIO (альтернативная функция I_TIMER_EXT). Тип события старта определяется битом START_TYPE регистра TMR_CFG. Окончанием счета является событие остановки счета таймера на выводе GPIO. Тип события остановки определяется битом STOP_TYPE регистра TMR_CFG. Текущее значение таймера находится в регистрах TMR_VALH, TMR_VALM и TMR_VALL.

### Статусы и прерывания

Статусы содержаться в регистре TMR_ST. В данном режиме вырабатывается статус переполнения таймера – бит OVW, статус запуска таймера по внешнему событию – бит START_EVENT и статус остановки таймера по внешнему событию – бит STOP_EVENT. На основании данных статусов возможно возникновение прерываний. Прерывание разрешается путем записи «1» в соответствующий бит регистра маски прерываний TMR_MSK.

### Алгоритм работы

Процедура настройки режима «Межсобытийный таймер»:

- в регистре TMR_CFG задать тип события запуска и остановки счета таймера путем записи требуемого значения в биты START_TYPE и STOP_TYPE;
- в регистре TMR_MSK разрешить необходимые прерывания;
- в регистре TMR_CTRL:
  - установить бит CYCLES в «0»;
  - установить бит T/C в «0»;
  - в биты MODE необходимо записать значение 10b;
  - установить бит EN_EXT в «0»;
  - установить бит EN в «1».
- текущее значения таймера можно вычитать из регистров TMR_VALH, TMR_VALM и TMR_VALL.

## Работа в режиме «Таймер-счетчик»

:::info Примечание
Данный режим работы поддерживают модули TIMER0 и TIMER1. Модуль TIMER2 данный режим работы не поддерживает. При запуске TIMER2 в режиме «Таймер-счетчик» модуль уйдет в состояние ожидания, выход из которого возможен только по отключению модуля.
:::

### Принцип работы

В режиме «Таймер-счетчик» модули взаимодействуют между собой. Один из модулей необходимо настроить в режим таймера, а второй в режим счетчика. На вход модуля, который работает в режиме счетчика может быть подана либо частота внутреннего RC-генератора, либо сигнал с соответствующего вывода GPIO (альтернативная функция I_TIMER_EXT). Источник сигнала, события на котором будут отслеживаться, определяется битом EVENT_TYPE регистра TMR_CFG модуля счетчика. Тип события старта задается в обоих модулях битом START_TYPE регистра TMR_CFG.

После настройки модуль в режиме таймера и модуль в режиме счетчика ожидают события старта от ранее выбранного источника. Затем модуль, работающий в режиме таймера, считает до момента остановки его модулем в режиме счетчика. Модуль в режиме счетчика считает до значения, записанного в регистры периода счета TMR_PRDH, TMR_PRDM и TMR_PRDL. Счетчик увеличивается на 1 каждый раз, когда фиксирует заданное событие. Тип события определяется битом FIX_TYPE регистра TMR_CFG. По завершению счета модуль в режиме счетчика формирует событие окончания счета для модуля, работающего в режиме таймера. В результате оба модуля прекращают счет. Перезаписывать значение TMR_PRDH, TMR_PRDM и TMR_PRDL для модуля в режиме счетчика в ходе работы запрещено.

При START_TYPE = FIX_TYPE значение, до которого будет считать счетчик, определяется как: <br /> N<sub>event</sub> = PRD + 1, где N<sub>event</sub> – количество тактов системной частоты.

При START_TYPE != FIX_TYPE: <br /> N<sub>event</sub> = PRD.

### Статусы и прерывания

Статусы содержаться в регистре TMR_ST. В данном режиме, для модуля, работающего в режиме таймера, вырабатывается статус переполнения таймера – бит OVW, статус запуска таймера по внешнему событию – бит START_EVENT и статус остановки таймера по внешнему событию – бит STOP_EVENT. Для модуля, работающего в режиме счетчика, вырабатывается статус запуска таймера по внешнему событию – бит START_EVENT. На основании данных статусов возможно возникновение прерываний. Прерывание разрешается путем записи «1» в соответствующий бит регистра маски прерываний TMR_MSK.

### Алгоритм работы

Процедура настройки режима «Таймер-счетчик» для модуля в режиме таймера:

- в регистре TMR_CFG задать тип события запуска счета таймера путем записи требуемого значения в бит START_TYPE;
- в регистре TMR_MSK разрешить необходимые прерывания;
- в регистре TMR_CTRL:
  - установить бит CYCLES в «0»;
  - установить бит T/C в «0»;
  - в биты MODE необходимо записать значение 11b;
  - установить бит EN_EXT в «1»;
  - установить бит EN в «1».
- текущее значения таймера можно вычитать из регистров TMR_VALH, TMR_VALM и TMR_VALL.

Бит EN_EXT разрешает соседнему модулю начать работу, таким образом синхронизируя запуск обоих модулей.

Процедура настройки режима «Таймер-счетчик» для модуля в режиме счетчика:

- в регистре TMR_CFG:
  - задать источник сигнала битом EVENT_TYPE;
  - задать тип события счетчика битом FIX_TYPE;
  - задать тип события запуска счета битом START_TYPE.
- в регистры TMR_PRDH, TMR_PRDM и TMR_PRDL записать требуемое значение периода счета таймера;
- в регистре TMR_MSK при необходимости разрешить прерывание;
- в регистре TMR_CTRL:
  - установить бит CYCLES в «0»;
  - установить бит T/C в «1»;
  - в биты MODE необходимо записать значение 11b;
  - установить бит EN_EXT в «1»;
  - установить бит EN в «1».
- текущее значения таймера можно вычитать из регистров TMR_VALH, TMR_VALM и TMR_VALL.

Бит EN_EXT разрешает соседнему модулю начать работу, таким образом синхронизируя запуск обоих модулей.

## Регистры таймеров

<table className="table">
<tbody>

  <tr>
    <th >№</th>
    <th >Аббревиатура</th>
    <th >Доступ</th>
    <th >Описание</th>
  </tr>
 <tr>
     <td  colSpan={4} ><b>TIMER0</b></td>
 </tr>
  <tr>
    <td  >2D00h </td>
    <td  >TMR0_CTRL</td>
    <td  >RW</td>
    <td  >Регистр управления</td>
  </tr>
  
   <tr>
    <td  >2D01h </td>
    <td  >TMR0_CFG</td>
    <td  >RW</td>
    <td  >Регистр конфигурации</td>
  </tr>
  
  <tr>
    <td  >2D02h </td>
    <td  >TMR0_PRDH</td>
    <td  >RW</td>
    <td  >Период счета таймера, старшая часть</td>
  </tr>
    
   <tr>
    <td  >2D03h </td>
    <td  >TMR0_PRDM</td>
    <td  >RW</td>
    <td  >Период счета таймера, старшая часть</td>
  </tr>

   <tr>
    <td  >2D04h </td>
    <td  >TMR0_PRDL</td>
    <td  >RW</td>
    <td  >Период счета таймера, младшая часть</td>
  </tr>

 <tr>
    <td  >2D05h </td>
    <td  >TMR0_VALH</td>
    <td  >R</td>
    <td  >Текущее значение таймера, старшая часть</td>
  </tr>

  <tr>
    <td  >2D06h </td>
    <td  >TMR0_VALM</td>
    <td  >R</td>
    <td  >Текущее значение таймера, средняя часть</td>
  </tr>

   <tr>
    <td  >2D07h </td>
    <td  >TMR0_VALL</td>
    <td  >R</td>
    <td  >Текущее значение таймера, младшая часть</td>
  </tr>

   <tr>
    <td  >2D08h </td>
    <td  >TMR0_MSK</td>
    <td  >RW</td>
    <td  >Регистр маски прерываний</td>
  </tr>

   <tr>
    <td  >2D09h </td>
    <td  >TMR0_ST</td>
    <td  >R</td>
    <td  >Регистр статусов</td>
  </tr>

 <tr>
     <td  colSpan={4} ><b>TIMER1</b></td>
 </tr>

  <tr>
    <td  >2D20h </td>
    <td  >TMR1_CTRL</td>
    <td  >RW</td>
    <td  >Регистр управления</td>
  </tr>
  
   <tr>
    <td  >2D21h </td>
    <td  >TMR1_CFG</td>
    <td  >RW</td>
    <td  >Регистр конфигурации</td>
  </tr>
  
  <tr>
    <td  >2D22h </td>
    <td  >TMR1_PRDH</td>
    <td  >RW</td>
    <td  >Период счета таймера, старшая часть</td>
  </tr>
    
   <tr>
    <td  >2D23h </td>
    <td  >TMR1_PRDM</td>
    <td  >RW</td>
    <td  >Период счета таймера, старшая часть</td>
  </tr>

   <tr>
    <td  >2D24h </td>
    <td  >TMR1_PRDL</td>
    <td  >RW</td>
    <td  >Период счета таймера, младшая часть</td>
  </tr>

 <tr>
    <td  >2D25h </td>
    <td  >TMR1_VALH</td>
    <td  >R</td>
    <td  >Текущее значение таймера, старшая часть</td>
  </tr>

  <tr>
    <td  >2D26h </td>
    <td  >TMR1_VALM</td>
    <td  >R</td>
    <td  >Текущее значение таймера, средняя часть</td>
  </tr>

   <tr>
    <td  >2D27h </td>
    <td  >TMR1_VALL</td>
    <td  >R</td>
    <td  >Текущее значение таймера, младшая часть</td>
  </tr>

   <tr>
    <td  >2D28h </td>
    <td  >TMR1_MSK</td>
    <td  >RW</td>
    <td  >Регистр маски прерываний</td>
  </tr>

   <tr>
    <td  >2D29h </td>
    <td  >TMR1_ST</td>
    <td  >R</td>
    <td  >Регистр статусов</td>
  </tr>

 <tr>
     <td  colSpan={4} ><b>TIMER2</b></td>
 </tr>

  <tr>
    <td  >2D40h </td>
    <td  >TMR2_CTRL</td>
    <td  >RW</td>
    <td  >Регистр управления</td>
  </tr>
  
   <tr>
    <td  >2D41h </td>
    <td  >TMR2_CFG</td>
    <td  >RW</td>
    <td  >Регистр конфигурации</td>
  </tr>
  
  <tr>
    <td  >2D42h </td>
    <td  >TMR2_PRDH</td>
    <td  >RW</td>
    <td  >Период счета таймера, старшая часть</td>
  </tr>
    
   <tr>
    <td  >2D43h </td>
    <td  >TMR2_PRDM</td>
    <td  >RW</td>
    <td  >Период счета таймера, старшая часть</td>
  </tr>

   <tr>
    <td  >2D44h </td>
    <td  >TMR2_PRDL</td>
    <td  >RW</td>
    <td  >Период счета таймера, младшая часть</td>
  </tr>

 <tr>
    <td  >2D45h </td>
    <td  >TMR2_VALH</td>
    <td  >R</td>
    <td  >Текущее значение таймера, старшая часть</td>
  </tr>

  <tr>
    <td  >2D46h </td>
    <td  >TMR2_VALM</td>
    <td  >R</td>
    <td  >Текущее значение таймера, средняя часть</td>
  </tr>

   <tr>
    <td  >2D47h </td>
    <td  >TMR2_VALL</td>
    <td  >R</td>
    <td  >Текущее значение таймера, младшая часть</td>
  </tr>

   <tr>
    <td  >2D48h </td>
    <td  >TMR2_MSK</td>
    <td  >RW</td>
    <td  >Регистр маски прерываний</td>
  </tr>

   <tr>
    <td  >2D49h </td>
    <td  >TMR2_ST</td>
    <td  >R</td>
    <td  >Регистр статусов</td>
  </tr>

</tbody>
</table>

### TMRx_CTRL

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={2} >Резерв</td>
    <td  >CYCLES</td>
    <td  >T/C</td>
    <td  colSpan={2} >MODE</td>
    <td  >EN_EXT</td>
    <td  >EN</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**CYCLES** – работа таймера по достижению значения периода:

- 1 – повторный счет с нуля;
- 0 – остановка счета.

**T/C** – работа в режиме таймера или счетчика, имеет значение только при MODE «Таймер-счетчик»:

- 1 – режим счетчика;
- 0 – режим таймера.

**MODE** – режимы работы модуля:

- 11b – «Таймер-счетчик»;
- 10b – «Межсобытийный таймер»;
- 01b – «Таймер с внешней остановкой»;
- 00b – «Простой таймер».

**EN_EXT** – разрешение работы соседнего модуля таймера, имеет значение только при MODE «Таймер-счетчик»:

- 1 – работа соседнего таймера разрешена;
- 0 – работа соседнего таймера запрещена.

При работе с регистрами модуля TIMER0 бит EN_EXT управляет модулем TIMER1. При работе   
с регистрами модуля TIMER1 бит EN_EXT управляет модулем TIMER0.

**EN** – разрешение работы таймера:

- 1 – таймер включен;
- 0 – таймер выключен.

### TMRx_CFG

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={4} >Резерв</td>
    <td  >EVENT_TYPE</td>
    <td  >FIX_TYPE</td>
    <td  >STOP_TYPE</td>
    <td  >START_TYPE</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**EVENT_TYPE** – источник сигнала, на котором отслеживаются события в режиме «Таймер-счетчик»:

- 1 – вывод GPIO;
- 0 – внутренний RC-генератор.

**FIX_TYPE** – тип события, которое считается счетчиком в режиме «Таймер-счетчик»:

- 1 – событие заднего фронта;
- 0 – событие переднего фронта.

**STOP_TYPE** – тип события остановки счета таймера:

- 1 – остановка по заднему фронту;
- 0 – остановка по переднему фронту.

**START_TYPE** – тип события старта счета таймера:

- 1 – старт по заднему фронту;
- 0 – старт по переднему фронту.

### TMRx_PRDH

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >PRD</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**PRD** – период счета таймера, старшая часть.

### TMRx_PRDM

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >PRD</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**PRD** – период счета таймера, средняя часть.

### TMRx_PRDL

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >PRD</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**PRD** – период счета таймера, младшая часть.

### TMRx_VALH

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >VAL</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**VAL** – текущее значение таймера, старшая часть.

### TMRx_VALM

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >VAL</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**VAL** – текущее значение таймера, средняя часть.

### TMRx_VALL

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >VAL</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**VAL** – текущее значение таймера, младшая часть.

### TMRx_MSK

Возможно формирование прерывания по любому биту статусного регистра TMR_ST. Расположение битов в TMR_ST и TMR_MSK аналогично.

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={4} >Резерв</td>
    <td  >STOP_EVENT</td>
    <td  >START_EVENT</td>
    <td  >OVW</td>
    <td  >END_PRD</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

Для каждого из битов справедливо:

- 1 – данное прерывание формируется;
- 0 – данное прерывание не формируется.

### TMRx_ST

Возможно формирование прерывания по любому биту статусного регистра TMR_ST. Расположение битов в TMR_ST и TMR_MSK аналогично.

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={4} rowSpan={2} >Резерв</td>
    <td  >STOP_EVENT</td>
    <td  >START_EVENT</td>
    <td  >OVW</td>
    <td  >END_PRD</td>
  </tr>

 <tr>
    <th >Тип статуса</th>
    <td  colSpan={4} >EVENT</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**STOP_EVENT** – зафиксировано событие остановки таймера;

**START_EVENT** – зафиксировано событие старта таймера;

**OVW** – зафиксировано переполнение таймера;

**END_PRD** – зафиксирован конец счета периода.
