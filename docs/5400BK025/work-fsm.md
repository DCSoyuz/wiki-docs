---
id: mk025-work-fsm
title: Рабочий автомат
sidebar_label: Рабочий автомат
sidebar_position: 12
---

Модуль «Рабочий автомат» представляет собой 24-разрядный таймер. Данный таймер считает «вверх» на частоте системы. Начало работы данного модуля автоматически означает переход системы в режим «Глубокий сон» более подробно смотрите пункт [«Режим «SLEEP»»](/docs/5400BK025/mk025-sleep). По окончанию счета будет сформировано немаскируемое прерывание, которое выведет систему из режима «Глубокий сон».

## Особенности работы

Актуальное значение периода счета обязательно должно быть записано перед включением модуля «Рабочий автомат». Таймер модуля «Рабочий автомат» работает на частоте системы. Это значит, что перед запуском данного модуля для снижения энергопотребления пользователь обязан переключить систему на частоту тактирования от RC-генератора в регистре CMM_CTRL.

Существует два способа запуска модуля «Рабочий автомат»:

- классический запуск;
- запуск с ожиданием.

При классическом запуске пользователь переключает частоту тактирования (модуль CMM). Пользователю необходимо узнать о завершении данного процесса по прерыванию, либо по чтению из статусного регистра CMM_ST (бит SWITCH). И только после этого пользователь может запустить модуль «Рабочий автомат». По записи сигнала EN в регистр FSM_CTRL модуль начнет счет «вверх» на частоте системы и переведет микроконтроллер в режим «Глубокий сон».

Для запуска с ожиданием пользователь должен записать «1» в бит EN_WSW регистра FSM_CTRL. Модуль «Рабочий автомат» будет ожидать события переключения частоты (модуль CMM). Пользователю необходимо записать команду на переключение частоты в регистр CMM_CTRL. По окончанию процесса переключения модуль «Рабочий автомат» автоматически начнет счет и инициирует процесс перехода в режим «Глубокий сон».

По окончанию счета «Рабочий автомат» сформирует прерывание, по которому микроконтроллер начнет выход из режима «Глубокий сон».

## Регистры «Рабочего автомата»

| №     | Аббревиатура | Доступ | Описание                |
| ----- | ------------ | ------ | ----------------------- |
| 2600h | FSM_CTRL     | W      | Регистр управления      |
| 2601h | FSM_PRDH     | RW     | Регистр периода счета 2 |
| 2602h | FSM_PRDM     | RW     | Регистр периода счета 1 |
| 2603h | FSM_PRDL     | RW     | Регистр периода счета 0 |

### FSM_CTRL

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={6} >Резерв</td>
    <td  >EN_WSW</td>
    <td  >EN</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**EN_WSW (Enable Wait Switch and Work)** – разрешение работы модуля по переключению частоты:

- 1 – ожидать переключения;
- 0 – модуль выключен.

**EN** – разрешение работы модуля:

- 1 – модуль включен;
- 0 – модуль выключен.

### FSM_PRDH

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >PRD</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**PRD** – период счета таймера, старшая часть.

### FSM_PRDM

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >PRD</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**PRD** – период счета таймера, средняя часть.

### FSM_PRDL

<table className="table">
<tbody>

  <tr>
    <th >Бит</th>
    <th >7</th>
    <th >6</th>
    <th >5</th>
    <th >4</th>
    <th >3</th>
    <th >2</th>
    <th >1</th>
    <th >0</th>
  </tr>

   <tr>
    <th >Назначение</th>
    <td  colSpan={8} >PRD</td>
  </tr>

   <tr>
    <th >Начальное значение</th>
    <td  colSpan={8} >0</td>
  </tr>
  
</tbody>
</table>

**PRD** – период счета таймера, младшая часть.

Значение, до которого будет считать модуль, определяется как:

$$
N_{clk} = PRD + 1,
$$

где N<sub>clk</sub> – количество тактов системной частоты.
